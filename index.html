<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VR Post-Test</title>
  <meta name="description" content="Immediate vs Delayed post-test"/>
  <link rel="icon" href="data:,">

  <!-- jsPsych CSS -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">

  <!-- SurveyJS (non-jQuery) CSS -->
  <link rel="stylesheet" href="https://unpkg.com/survey-core@1.11.7/defaultV2.min.css">
  <link rel="stylesheet" href="https://unpkg.com/survey-js-ui@1.11.7/survey-js-ui.min.css">

  <!-- jsPsych core (UMD) -->
  <script src="https://unpkg.com/jspsych@7.3.4/dist/jspsych.js" defer></script>

  <!-- jsPsych plugins (ALL UMD to avoid ESM 'import' errors) -->
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3/dist/index.umd.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3/dist/index.umd.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3/dist/index.umd.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3/dist/index.umd.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@1.0.3/dist/index.umd.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.0.3/dist/index.umd.js" defer></script>
  <!-- If you use audio-button-response anywhere, add its UMD too:
  <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.3/dist/index.umd.js" defer></script> -->

  <!-- SurveyJS (non-jQuery) JS -->
  <script src="https://unpkg.com/survey-core@1.11.7/survey.core.min.js" defer></script>
  <script src="https://unpkg.com/survey-js-ui@1.11.7/survey-js-ui.min.js" defer></script>

  <style>
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    header h1 { font-size: 20px; margin: 0; }
    #jspsych-target { min-height: 60vh; }
    .precheck { font-size: 12px; color:#666; margin-bottom:12px; }
    .warn { color:#c1272d; font-weight: 600; }
    .controls { display:flex; gap:8px; align-items:center; margin: 12px 0 20px; }
    input[type="text"] { padding:8px 10px; border:1px solid #ccc; border-radius:6px; }
    button { padding:8px 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>VR Post-Test</h1>
      <div class="precheck" id="lib-check">Loading libraries…</div>
    </header>

    <div class="controls">
      <label for="pid">Participant ID:</label>
      <input id="pid" type="text" placeholder="e.g., S123"/>
      <button id="btn-immediate">Start Immediate</button>
      <button id="btn-delayed">Start Delayed</button>
    </div>

    <!-- jsPsych renders here -->
    <div id="jspsych-target"></div>

    <details>
      <summary>Help / Requirements</summary>
      <ul>
        <li>Assets should exist:
          <ul>
            <li><code>sounds/*.mp3</code></li>
            <li><code>img/*.jpg|jpeg|svg</code></li>
            <li><code>pron/*.mp3</code> (optional model audio)</li>
          </ul>
        </li>
        <li>SurveyJS is the non-jQuery build (survey-core + survey-js-ui).</li>
      </ul>
    </details>
  </div>

  <!-- Inline bridge: jsPsych ↔ SurveyJS (simple & robust) -->
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof window.Survey !== 'object') return; // survey-core not yet loaded

      // Define a minimal jsPsychSurvey plugin as a global variable,
      // so you can use: { type: window['jsPsychSurvey'], survey_json: {...} }
      window.jsPsychSurvey = {
        info: {
          name: 'jspsych-survey',
          parameters: {
            survey_json: { type: jsPsych.ParameterType.COMPLEX, default: {} },
            data:        { type: jsPsych.ParameterType.COMPLEX, default: {} }
          }
        },
        trial: function(display_element, trial){
          // Container
          const container = document.createElement('div');
          container.id = 'surveyjs-container';
          display_element.appendChild(container);

          // Build the model and render
          const model = new Survey.Model(trial.survey_json || {});
          const app = document.createElement('div');
          container.appendChild(app);
          Survey.SurveyNG.render(app, { model });

          // When complete, finish trial with responses
          model.onComplete.add(() => {
            const response = model.data || {};
            jsPsych.finishTrial({ response });
          });
        }
      };
    });
  </script>

  <!-- Your posttest logic -->
  <script src="posttest.js" defer></script>

  <!-- Wire the buttons + basic library check -->
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('lib-check');
      const ok = [
        ['initJsPsych', typeof window.initJsPsych === 'function'],
        ['Survey',      typeof window.Survey === 'object']
      ];
      const missing = ok.filter(([_,v]) => !v).map(([k]) => k);
      el.textContent = missing.length ? ('Missing: ' + missing.join(', ')) : '✓ All components loaded';

      const getPid = () => document.getElementById('pid')?.value.trim() || `S_${Date.now()}`;
      document.getElementById('btn-immediate')?.addEventListener('click', () => {
        if (typeof window.__START_POSTTEST !== 'function') return alert('posttest.js not loaded yet.');
        window.__START_POSTTEST(getPid(), false);
      });
      document.getElementById('btn-delayed')?.addEventListener('click', () => {
        if (typeof window.__START_POSTTEST !== 'function') return alert('posttest.js not loaded yet.');
        window.__START_POSTTEST(getPid(), true);
      });
    });
  </script>
</body>
</html>
