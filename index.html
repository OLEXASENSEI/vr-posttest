<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VR Post-Test</title>
  <meta name="description" content="Immediate vs Delayed post-test"/>
  <link rel="icon" href="data:,">

  <!-- jsPsych CSS -->
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet">

  <!-- SurveyJS CSS (CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/survey-core@1.11.7/defaultV2.min.css">
  <link rel="stylesheet" href="https://unpkg.com/survey-js-ui@1.11.7/survey-js-ui.min.css">

  <!-- 1) jsPsych core -->
  <script src="https://unpkg.com/jspsych@7.3.4/dist/jspsych.js" defer></script>

  <!-- 2) jsPsych plugins you use -->
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3/dist/index.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3/dist/index.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3/dist/index.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.3/dist/index.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@1.0.3/dist/index.js" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.0.3/dist/index.js" defer></script>

  <!-- 3) SurveyJS (CDN, non-jQuery build) -->
  <script src="https://unpkg.com/survey-core@1.11.7/survey.core.min.js" defer></script>
  <script src="https://unpkg.com/survey-js-ui@1.11.7/survey-js-ui.min.js" defer></script>

  <!-- 4) jsPsych ↔ SurveyJS bridge plugin (YOUR file) -->
  <!-- Make sure this path actually exists in your repo. For example: /plugins/jspsych-survey.js -->
  <script src="/plugins/jspsych-survey.js" defer></script>

  <!-- 5) Optional safety shim: if the bridge isn’t present, define a no-op to avoid crashes -->
  <script defer>
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof window.Survey === 'undefined') {
        console.warn('[posttest] SurveyJS (Survey) is not loaded — Survey pages will be skipped.');
      }
      // If your bridge plugin didn’t load, register a stub that lets the rest run.
      const hasBridge = !!(window.jsPsych && window.jsPsych.plugins && (window.jsPsych.plugins['survey'] || window.jsPsych.plugins['jspsych-survey']));
      if (!hasBridge) {
        console.warn('[posttest] jsPsych Survey bridge plugin not found. Defining a stub to avoid errors.');
        (window.jsPsych ??= {}).plugins ??= {};
        window.jsPsych.plugins['jspsych-survey'] = {
          info: { name: 'jspsych-survey', parameters: {} },
          trial: (display_element, trial) => {
            display_element.innerHTML = '<p style="color:#c00">Survey plugin missing. This page is skipped.</p>';
            jsPsych.finishTrial({ skipped: true, reason: 'survey_plugin_missing' });
          }
        };
      }
    });
  </script>

  <style>
    /* your CSS as before */
  </style>
</head>
<body>
  <!-- your existing HTML ... -->

  <!-- Your post-test logic -->
  <script src="posttest.js" defer></script>

  <!-- Wire the buttons -->
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const getPid = () => document.getElementById('pid')?.value.trim() || `S_${Date.now()}`;

      document.getElementById('btn-immediate')?.addEventListener('click', () => {
        window.__START_POSTTEST(getPid(), false);
      });
      document.getElementById('btn-delayed')?.addEventListener('click', () => {
        window.__START_POSTTEST(getPid(), true);
      });
    });
  </script>
</body>
</html>
